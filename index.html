<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>Helix AI Orb</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1e293b">

<style>
  /* --- LAYOUT & BACKGROUND --- */
  body {
    background: radial-gradient(circle at top, #1e293b, #0f172a);
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    height: 100dvh; width: 100vw; margin: 0; 
    display: flex; flex-direction: column; align-items: center;
    overflow: hidden; user-select: none;
  }

  /* --- HEADER --- */
  header {
    width: 100%; padding: 15px 20px; box-sizing: border-box;
    display: flex; justify-content: space-between; align-items: center;
    position: absolute; top: 0; left: 0; z-index: 10;
  }
  .app-name { font-weight: 700; font-size: 18px; color: #60a5fa; letter-spacing: 0.5px; }
  .settings-btn { background: none; border: none; font-size: 20px; color: #94a3b8; cursor: pointer; }

  /* --- GLOWING ORB --- */
  #orb-container {
    flex-grow: 1; display: flex; flex-direction: column; 
    justify-content: center; align-items: center;
    width: 100%; position: relative;
  }
  
  #orb {
    width: 140px; height: 140px;
    background: radial-gradient(circle at 30% 30%, #ffffff, #e2e8f0, #94a3b8);
    border-radius: 50%;
    box-shadow: 0 0 60px rgba(255, 255, 255, 0.1), inset 0 0 20px rgba(0,0,0,0.2);
    position: relative; z-index: 5;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    animation: breathe 4s ease-in-out infinite;
  }
  
  /* Orb States */
  #orb.listening { 
    background: radial-gradient(circle at 30% 30%, #fff, #86efac, #22c55e);
    box-shadow: 0 0 80px rgba(34, 197, 94, 0.4); transform: scale(1.1);
  }
  #orb.thinking { 
    background: radial-gradient(circle at 30% 30%, #fff, #fca5a5, #ef4444);
    box-shadow: 0 0 80px rgba(239, 68, 68, 0.4); animation: spin 1s linear infinite;
  }
  #orb.talking { 
    background: radial-gradient(circle at 30% 30%, #fff, #93c5fd, #3b82f6);
    box-shadow: 0 0 80px rgba(59, 130, 246, 0.4); animation: pulse 0.5s ease-in-out infinite alternate;
  }

  @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  #status-text {
    margin-top: 30px; font-size: 22px; font-weight: 600; color: #60a5fa;
    text-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
  }

  /* --- CHAT/RESPONSE AREA (Hidden by default, shows on interaction) --- */
  #console {
    width: 90%; max-height: 150px; overflow-y: auto;
    background: rgba(15, 23, 42, 0.6); border-radius: 12px;
    padding: 10px; margin-bottom: 20px; font-size: 14px; color: #cbd5e1;
    border: 1px solid rgba(255,255,255,0.1); display: none;
  }
  #console.active { display: block; }

  /* --- CONTROL BAR --- */
  #controls {
    width: 100%; padding: 20px; box-sizing: border-box;
    background: #1e293b; border-top: 1px solid #334155;
    border-radius: 24px 24px 0 0; display: flex; flex-direction: column; gap: 20px;
  }

  #text-input-row {
    width: 100%; position: relative;
  }
  #txt-input {
    width: 100%; padding: 15px 20px; border-radius: 30px;
    background: #334155; border: none; color: white; font-size: 16px;
    outline: none; box-sizing: border-box;
  }
  #txt-input::placeholder { color: #94a3b8; }

  /* CIRCLE BUTTONS ROW */
  #action-row {
    display: flex; justify-content: center; gap: 15px;
  }
  
  .circle-btn {
    width: 50px; height: 50px; border-radius: 50%; border: none;
    display: flex; justify-content: center; align-items: center;
    font-size: 20px; cursor: pointer; transition: transform 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  }
  .circle-btn:active { transform: scale(0.9); }

  /* Colors matching screenshot style */
  .btn-blue { background: #3b82f6; color: white; }   /* Play/Action */
  .btn-teal { background: #2dd4bf; color: #0f172a; } /* Edit/Write */
  .btn-indigo { background: #6366f1; color: white; } /* Camera */
  .btn-orange { background: #f59e0b; color: white; } /* Gallery */
  .btn-cyan { background: #06b6d4; color: white; }   /* Mic */

  /* --- CAMERA OVERLAY --- */
  #camera-overlay {
    display: none; position: fixed; inset: 0; background: #000; z-index: 50;
    flex-direction: column;
  }
  video { width: 100%; height: 100%; object-fit: cover; }
  #cam-controls {
    position: absolute; bottom: 30px; width: 100%; text-align: center;
  }
  #snap-btn {
    width: 70px; height: 70px; border-radius: 50%; background: white;
    border: 4px solid rgba(0,0,0,0.2); cursor: pointer;
  }

  /* --- SETTINGS MODAL --- */
  #settings-modal {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    z-index: 100; justify-content: center; align-items: center;
  }
  .modal-box {
    background: #1e293b; padding: 25px; border-radius: 16px; width: 85%; max-width: 320px;
    border: 1px solid #334155; display: flex; flex-direction: column; gap: 15px;
  }
  .modal-box h2 { margin: 0; color: #60a5fa; font-size: 20px; }
  .input-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; font-weight: bold; }
  .input-group input { 
    width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155; 
    border-radius: 8px; color: white; outline: none; box-sizing: border-box;
  }
  .save-btn {
    padding: 12px; background: #22c55e; color: white; border: none; border-radius: 8px;
    font-weight: bold; cursor: pointer; margin-top: 10px;
  }
  .close-btn { background: none; border: none; color: #94a3b8; cursor: pointer; margin-top: 5px; }

  #img-preview { 
    display: none; width: 40px; height: 40px; border-radius: 8px; 
    background-size: cover; position: absolute; right: 10px; top: 10px; border: 2px solid white; 
  }
  canvas { display: none; }
</style>
</head>
<body>

<header>
    <div class="app-name">AI Assistant</div>
    <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
</header>

<div id="orb-container">
    <div id="orb"></div>
    <div id="status-text">Helix AI</div>
</div>

<div id="console"></div>

<div id="controls">
    <div id="text-input-row">
        <input id="txt-input" type="text" placeholder="Type your message..." onkeydown="if(event.key==='Enter') sendText()">
        <div id="img-preview" onclick="clearImage()"></div>
    </div>

    <div id="action-row">
        <button class="circle-btn btn-blue" onclick="sendText()">‚ñ∂</button>
        <button class="circle-btn btn-teal" onclick="document.getElementById('txt-input').focus()">‚úé</button>
        <button class="circle-btn btn-indigo" onclick="startCamera()">üì∑</button>
        <button class="circle-btn btn-orange" onclick="document.getElementById('file-in').click()">üñºÔ∏è</button>
        <button class="circle-btn btn-cyan" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
    </div>
</div>

<input type="file" id="file-in" accept="image/*" style="display:none" onchange="handleFile(event)">

<div id="camera-overlay">
    <video id="cam-feed" autoplay playsinline></video>
    <div id="cam-controls">
        <button id="snap-btn" onclick="snapPhoto()"></button>
    </div>
</div>
<canvas id="canvas"></canvas>

<div id="settings-modal">
    <div class="modal-box">
        <h2>Configuration</h2>
        <div class="input-group">
            <label>Google Gemini API Key</label>
            <input type="password" id="key-google" placeholder="Paste API Key">
        </div>
        <div class="input-group">
            <label>ElevenLabs API Key (Optional)</label>
            <input type="password" id="key-eleven" placeholder="Paste API Key">
        </div>
        <button class="save-btn" onclick="saveSettings()">Save Settings</button>
        <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
</div>

<script>
// --- CONFIG ---
const MODEL_NAME = "gemini-2.5-flash"; 

// --- STATE ---
let apiKey = "", elevenKey = "", voiceId = "21m00Tcm4TlvDq8ikWAM";
let history = [], recognition = null, synth = window.speechSynthesis;
let isListening = false, isSpeaking = false;
let currentImg = null, currentMime = null, stream = null;
let audioPlayer = new Audio();

window.onload = () => { loadSettings(); };

// --- UI HELPERS ---
function setStatus(state, text) {
    const orb = document.getElementById('orb');
    const label = document.getElementById('status-text');
    orb.className = state; // listening, thinking, talking
    label.innerText = text;
}

function addMessage(role, text) {
    const con = document.getElementById('console');
    con.classList.add('active'); // Show console on first message
    
    const div = document.createElement('div');
    div.style.marginBottom = "8px";
    div.style.color = role === 'user' ? '#94a3b8' : '#e2e8f0';
    div.innerHTML = `<strong>${role === 'user' ? 'You' : 'Helix'}:</strong> ${text}`;
    con.appendChild(div);
    con.scrollTop = con.scrollHeight;
}

// --- SETTINGS ---
function openSettings() { 
    document.getElementById('settings-modal').style.display = 'flex';
    document.getElementById('key-google').value = apiKey;
    document.getElementById('key-eleven').value = elevenKey;
}
function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

function saveSettings() {
    apiKey = document.getElementById('key-google').value.trim();
    elevenKey = document.getElementById('key-eleven').value.trim();
    localStorage.setItem('helix_orb_keys', JSON.stringify({apiKey, elevenKey}));
    closeSettings();
    setStatus('', 'Ready');
}

function loadSettings() {
    let data = JSON.parse(localStorage.getItem('helix_orb_keys') || '{}');
    apiKey = data.apiKey || ""; elevenKey = data.elevenKey || "";
    if(!apiKey) setTimeout(() => { setStatus('', 'Set API Key'); openSettings(); }, 1000);
}

// --- MIC ---
function toggleMic() {
    if(!apiKey) return openSettings();
    if(isListening) { stopListening(); } else { startListening(); }
}

if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    let SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        isListening = true; setStatus('listening', 'Listening...');
    };
    recognition.onend = () => {
        if(isListening) recognition.start(); // Loop
        else setStatus('', 'Helix AI');
    };
    recognition.onresult = (e) => {
        let txt = e.results[0][0].transcript;
        if(txt) { isListening = false; recognition.stop(); send(txt); }
    };
} else { alert("Mic not supported"); }

function startListening() { isListening=true; recognition.start(); }
function stopListening() { isListening=false; recognition.stop(); }

// --- CAMERA ---
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        document.getElementById('cam-feed').srcObject = stream;
        document.getElementById('camera-overlay').style.display = 'flex';
    } catch(e) { alert("Camera failed"); }
}

function snapPhoto() {
    let v = document.getElementById('cam-feed');
    let c = document.getElementById('canvas');
    // Resize to max 600px width
    let ratio = v.videoWidth/v.videoHeight;
    let w = 600; let h = w/ratio;
    c.width = w; c.height = h;
    c.getContext('2d').drawImage(v,0,0,w,h);
    
    currentImg = c.toDataURL('image/jpeg', 0.6).split(',')[1];
    currentMime = 'image/jpeg';
    
    stream.getTracks().forEach(t=>t.stop());
    document.getElementById('camera-overlay').style.display = 'none';
    
    // Show preview thumbnail
    let p = document.getElementById('img-preview');
    p.style.display = 'block';
    p.style.backgroundImage = `url(${c.toDataURL()})`;
}

function handleFile(e) {
    let f = e.target.files[0];
    if(!f) return;
    let r = new FileReader();
    r.onload = ev => {
        let img = new Image();
        img.onload = () => {
            let c = document.getElementById('canvas');
            let scale = Math.min(1, 600/img.width);
            c.width = img.width*scale; c.height = img.height*scale;
            c.getContext('2d').drawImage(img,0,0,c.width,c.height);
            currentImg = c.toDataURL('image/jpeg',0.6).split(',')[1];
            currentMime = 'image/jpeg';
            let p = document.getElementById('img-preview');
            p.style.display='block';
            p.style.backgroundImage=`url(${c.toDataURL()})`;
        }
        img.src = ev.target.result;
    }
    r.readAsDataURL(f);
}
function clearImage() { currentImg=null; document.getElementById('img-preview').style.display='none'; }

// --- API ---
async function send(txt) {
    let input = document.getElementById('txt-input');
    let text = txt || input.value.trim();
    if(!text && !currentImg) return;
    if(!apiKey) return openSettings();

    input.value = "";
    setStatus('thinking', 'Thinking...');
    addMessage('user', text + (currentImg ? " [Image]" : ""));

    let parts = [{text: text}];
    if(currentImg) parts.push({inline_data:{mime_type:currentMime, data:currentImg}});

    // History limited to 6 turns to save context space
    let historyContext = history.slice(-6).map(h => ({ role: h.role, parts: [{ text: h.text }] }));
    let payload = {
        contents: [...historyContext, { role: "user", parts: parts }],
        generationConfig: { maxOutputTokens: 300 }
    };

    try {
        let req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        let data = await req.json();
        if(data.error) throw new Error(data.error.message);
        
        let ans = data.candidates[0].content.parts[0].text;
        
        if(currentImg) clearImage();
        history.push({role:'user', text: text||"[Img]"}, {role:'model', text:ans});
        
        addMessage('model', ans);
        setStatus('talking', 'Speaking...');
        speak(ans);
    } catch(e) {
        setStatus('', 'Error');
        addMessage('model', "Error: " + e.message);
    }
}

// --- TTS ---
async function speak(txt) {
    if(elevenKey) {
        try {
            let res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                method:'POST', headers:{'xi-api-key':elevenKey,'Content-Type':'application/json'},
                body:JSON.stringify({text:txt, model_id:"eleven_monolingual_v1"})
            });
            let blob = await res.blob();
            audioPlayer.src = URL.createObjectURL(blob);
            audioPlayer.play();
            audioPlayer.onended = () => { setStatus('', 'Helix AI'); };
        } catch(e) { speakFallback(txt); }
    } else { speakFallback(txt); }
}
function speakFallback(txt) {
    let u = new SpeechSynthesisUtterance(txt);
    u.onend = () => { setStatus('', 'Helix AI'); };
    synth.speak(u);
}
</script>
</body>
</html>

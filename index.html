<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
<title>Helix v47.5 - Gemini 2.5 Flash</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='black'/><circle cx='50' cy='50' r='40' stroke='cyan' stroke-width='5' fill='none'/><text x='50' y='65' font-family='sans-serif' font-size='50' fill='cyan' text-anchor='middle'>H</text></svg>">

<style>
  body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
  #scene { height: 25%; min-height: 140px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; position: relative; }
  #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; z-index: 2; animation: float 6s ease-in-out infinite; }
  #core span { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: rgba(0,0,0,0.6); font-family: monospace; pointer-events: none; }
  
  /* Orb States */
  #core.listening { background: radial-gradient(circle at 30% 30%, #fff, #5f5, #010) !important; box-shadow: 0 0 60px lime !important; transform: scale(1.1); }
  #core.thinking { background: radial-gradient(circle at 30% 30%, #fff, #fb0, #420) !important; box-shadow: 0 0 50px orange !important; animation: pulseFast 0.5s alternate infinite !important; }
  #core.talking { background: radial-gradient(circle at 30% 30%, #fff, #a0f, #205) !important; box-shadow: 0 0 60px #a0f !important; animation: pulse 0.3s alternate infinite !important; }
  
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.08); } }
  @keyframes pulseFast { 0% { transform: scale(0.95); opacity: 0.8; } 100% { transform: scale(1.0); opacity: 1; } }

  #ui-layer { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #0a0a0a; gap: 10px; overflow: hidden; position: relative; }
  #header-row { display: flex; justify-content: space-between; align-items: center; min-height: 30px; }
  #model-badge { background: #112; color: #aaf; border: 1px solid #336; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; font-family: monospace; }
  
  #console { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #222; border-radius: 8px; background: #000; display: flex; flex-direction: column; gap: 10px; }
  .msg { padding: 10px; border-radius: 8px; font-size: 15px; max-width: 90%; line-height: 1.4; word-wrap: break-word; }
  .user { align-self: flex-end; background: #222; color: #fff; }
  .ai { align-self: flex-start; color: #ccc; border: 1px solid #333; width: 100%; box-sizing: border-box; }
  .system { align-self: center; font-size: 11px; color: #555; font-family: monospace; }
  .code-block { background: #111; padding: 10px; margin-top:5px; border-radius:6px; font-family:monospace; font-size:12px; overflow-x:auto; border:1px solid #333; color: #0f0; white-space: pre-wrap; }

  #settings-panel { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; align-items: center; padding: 30px; box-sizing: border-box; overflow-y: auto; }
  #settings-panel.active { display: flex !important; }
  .setting-label { color:#888; font-size:12px; margin-bottom:5px; margin-top:15px; text-align:left; width:100%; font-weight:bold; }
  .key-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; margin-bottom: 10px; font-family: monospace; font-size: 14px; text-align: center; box-sizing: border-box; }
  #save-btn { width: 100%; padding: 20px; background: cyan; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 10px; }

  #controls { display: flex; flex-direction: column; gap: 8px; margin-top: auto; }
  #input-row { display: flex; gap: 8px; align-items: center; }
  #txt-input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: white; font-size: 16px; outline: none; }
  .action-btn { background: #222; color: #aaa; border: 1px solid #333; border-radius: 12px; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  #mic-btn.active { background: #060; border-color: lime; color: #fff; box-shadow: 0 0 15px #060; }
</style>
</head>
<body>

<div id="settings-panel">
    <h2 style="color:cyan; font-family:monospace;">HELIX CONFIG</h2>
    
    <div class="setting-label">Gemini Model Selector</div>
    <select id="model-select" class="key-input" style="height: 50px;">
        <option value="gemini-2.5-flash">Gemini 2.5 Flash (Default)</option>
        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
    </select>
    
    <div class="setting-label">Google API Key (Gemini)</div>
    <input type="text" id="google-key-input" class="key-input" placeholder="AIza... (Saved Locally)">
    
    <div class="setting-label">ElevenLabs API Key (Voice)</div>
    <input type="text" id="eleven-key-input" class="key-input" placeholder="Enter Voice Key...">
    
    <button id="save-btn" onclick="saveSettings()">SAVE & INITIALIZE</button>
</div>

<div id="scene">
    <div id="core"><span id="orb-text">HELIX</span></div>
</div>

<div id="ui-layer">
  <div id="header-row">
    <div id="model-badge">READY</div>
    <button class="action-btn" style="width:auto; padding: 0 15px; font-size: 14px;" onclick="toggleSettings()">âš™ SETTINGS</button>
  </div>

  <div id="console"></div>
    
  <div id="controls">
    <div id="input-row">
        <input id="txt-input" placeholder="Command Helix..." onkeydown="if(event.key==='Enter') sendText()">
        <button id="mic-btn" class="action-btn" onclick="handleMicClick()">ðŸŽ¤</button>
        <button id="send-btn" class="action-btn" onclick="sendText()" style="color:cyan;">â–¶</button>
    </div>
  </div>
</div>

<script>
// --- Global State ---
let googleKey = localStorage.getItem('helix_google_key_v47') || "";
let elevenKey = localStorage.getItem('helix_eleven_key_v47') || "";
let currentModel = localStorage.getItem('helix_model_v47') || "gemini-2.5-flash";
let isSpeaking = false;
let micEnabled = false; 
let recognition = null;

// --- Persistent Speech Recognition Logic ---
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.continuous = true;    // Don't stop when I pause
    recognition.interimResults = false; // Only send final text
    recognition.lang = 'en-US';

    recognition.onstart = () => {
        updateOrb('listening', 'LISTENING');
        document.getElementById('mic-btn').classList.add('active');
    };

    // This is the CRITICAL fix: Re-start the mic if it turns off unexpectedly
    recognition.onend = () => {
        if (micEnabled) {
            console.log("Mic timed out/ended, restarting for persistent mode...");
            try { recognition.start(); } catch(e) {}
        } else {
            document.getElementById('mic-btn').classList.remove('active');
            if(!isSpeaking) updateOrb('', 'HELIX');
        }
    };

    recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            }
        }
        
        if(finalTranscript.trim()) {
            document.getElementById('txt-input').value = finalTranscript;
            sendText(); 
        }
    };

    recognition.onerror = (event) => {
        console.error("Speech Recognition Error:", event.error);
        if (event.error === 'no-speech' && micEnabled) {
            // Chrome often stops on silence; restart if toggle is still ON
            try { recognition.stop(); } catch(e) {}
        }
    };
}

window.onload = () => {
    updateBadge();
    if (!googleKey) {
        document.getElementById('settings-panel').classList.add('active');
    } else {
        addMessage('system', "Helix Online. Continuous mic ready.");
    }
};

// --- Settings Logic ---
function toggleSettings() {
    const panel = document.getElementById('settings-panel');
    panel.classList.toggle('active');
    document.getElementById('google-key-input').value = googleKey;
    document.getElementById('eleven-key-input').value = elevenKey;
    document.getElementById('model-select').value = currentModel;
}

function saveSettings() {
    googleKey = document.getElementById('google-key-input').value.trim();
    elevenKey = document.getElementById('eleven-key-input').value.trim();
    currentModel = document.getElementById('model-select').value;

    localStorage.setItem('helix_google_key_v47', googleKey);
    localStorage.setItem('helix_eleven_key_v47', elevenKey);
    localStorage.setItem('helix_model_v47', currentModel);

    document.getElementById('settings-panel').classList.remove('active');
    updateBadge();
    addMessage('system', `Settings saved. Using ${currentModel}.`);
}

function updateBadge() {
    document.getElementById('model-badge').innerText = currentModel.toUpperCase().replace(/-/g, ' ');
}

// --- Mic Toggle Logic ---
function handleMicClick() {
    if (!recognition) {
        alert("Speech Recognition not supported.");
        return;
    }

    if (!micEnabled) {
        micEnabled = true;
        try { recognition.start(); } catch(e) { console.error(e); }
    } else {
        micEnabled = false;
        recognition.stop(); 
        updateOrb('', 'HELIX');
    }
}

// --- AI Interaction ---
async function sendText() {
    const input = document.getElementById('txt-input');
    const text = input.value.trim();
    if (!text || !googleKey) return;

    input.value = "";
    addMessage('user', text);
    
    // Only show thinking if mic is off; if mic is on, we keep "Listening" orb
    if (!micEnabled) updateOrb('thinking', 'THINKING');

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${googleKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ role: 'user', parts: [{ text: text }] }]
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const aiMsg = data.candidates[0].content.parts[0].text;
        addMessage('ai', aiMsg);
        
        if (micEnabled) updateOrb('listening', 'LISTENING');
        else updateOrb('', 'HELIX');
        
        speak(aiMsg);
        
    } catch (e) {
        addMessage('system', "API Error: " + e.message);
        updateOrb('', 'ERROR');
    }
}

// --- Voice & UI Utils ---
async function speak(text) {
    let cleanText = text.replace(/```[\s\S]*?```/g, " provided code below ").replace(/[*#]/g, '').slice(0, 500);
    isSpeaking = true;

    if (elevenKey && elevenKey.length > 5) {
        updateOrb('talking', 'SPEAKING');
        try {
            const res = await fetch("https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM", {
                method: "POST",
                headers: { "xi-api-key": elevenKey, "Content-Type": "application/json" },
                body: JSON.stringify({ text: cleanText, model_id: "eleven_turbo_v2_5" })
            });
            if (res.ok) {
                const blob = await res.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.onended = () => { 
                    isSpeaking = false; 
                    if (micEnabled) updateOrb('listening', 'LISTENING');
                    else updateOrb('', 'HELIX');
                };
                audio.play();
                return;
            }
        } catch (e) { console.error("ElevenLabs Error"); }
    }
    
    const u = new SpeechSynthesisUtterance(cleanText);
    u.onend = () => { 
        isSpeaking = false; 
        if (micEnabled) updateOrb('listening', 'LISTENING');
        else updateOrb('', 'HELIX');
    };
    window.speechSynthesis.speak(u);
}

function updateOrb(cls, txt) {
    const orb = document.getElementById('core');
    orb.className = cls || '';
    document.getElementById('orb-text').innerText = txt;
}

function addMessage(role, text) {
    const consoleDiv = document.getElementById('console');
    const msg = document.createElement('div');
    msg.className = 'msg ' + (role === 'ai' ? 'ai' : role === 'user' ? 'user' : 'system');
    
    let formatted = text.replace(/```([\s\S]*?)```/g, '<div class="code-block">$1</div>');
    msg.innerHTML = formatted;
    
    consoleDiv.appendChild(msg);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
}
</script>
</body>
</html>
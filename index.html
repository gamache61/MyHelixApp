<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>HelixApp</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Banana_Icon.svg/1024px-Banana_Icon.svg.png">

<style>
  /* --- LAYOUT --- */
  body { background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
  
  /* --- SCENE --- */
  #scene { height: 25%; min-height: 140px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; }
  #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; animation: float 6s ease-in-out infinite; transition: 0.3s; }
  #core span { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: rgba(0,0,0,0.6); font-family: monospace; }
  
  /* STATES */
  .thinking { animation: pulse 0.4s alternate infinite !important; filter: hue-rotate(40deg); transform: scale(0.95); }
  .error { filter: hue-rotate(280deg); box-shadow: 0 0 50px red !important; }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
  @keyframes pulse { to { transform: scale(1.1); opacity: 0.8; } }

  /* --- CHAT --- */
  #console { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
  .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; line-height: 1.5; font-size: 15px; word-wrap: break-word; }
  .user { align-self: flex-end; background: #222; color: #fff; }
  .ai { align-self: flex-start; background: #0a0a0a; border: 1px solid #333; color: #ddd; }
  .sys-msg { align-self: center; font-size: 11px; color: #666; font-style: italic; margin: 5px 0; }
  .code-block { background: #111; padding: 10px; margin-top:5px; border-radius:6px; font-family:monospace; font-size:12px; overflow-x:auto; border:1px solid #333; }

  /* --- CONTROLS --- */
  #header-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #0a0a0a; border-bottom: 1px solid #222; }
  #model-select { background: #222; color: cyan; border: 1px solid #444; padding: 6px; border-radius: 6px; font-size: 12px; font-weight: bold; outline: none; flex-grow: 1; margin-right: 10px; }
  #trash-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; opacity: 0.7; }
  
  #controls { padding: 10px; background: #111; display: flex; flex-direction: column; gap: 10px; }
  #input-row { display: flex; gap: 10px; }
  #txt-input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #000; color: white; font-size: 16px; outline: none; }
  #send-btn { width: 50px; background: #222; border: 1px solid #333; color: cyan; border-radius: 12px; font-size: 20px; cursor: pointer; }
  
  #image-preview { display: none; width: 60px; height: 60px; border-radius: 6px; border: 1px solid cyan; background-size: cover; margin-bottom: 5px; }
  
  /* HIDDEN */
  #file-input { display: none; }
</style>
</head>
<body>

<div id="scene">
    <div id="core"><span id="orb-text">HELIX</span></div>
</div>

<div id="header-row">
    <select id="model-select" onchange="manualSwitch()">
        <option value="gemini-1.5-flash-002">üõ°Ô∏è 1.5 Flash v2 (Stable)</option>
        <option value="gemini-1.5-flash-001">üõ°Ô∏è 1.5 Flash v1 (Backup)</option>
        <option value="gemini-1.5-pro-002">üß† 1.5 Pro v2 (Smart)</option>
        <option value="gemini-2.0-flash-exp">‚ö° 2.0 Flash (Exp)</option>
    </select>
    <button id="trash-btn" onclick="clearMemory()">üóëÔ∏è</button>
</div>

<div id="console"></div>

<div id="controls">
    <div id="image-preview" onclick="clearImage()"></div>
    <div id="input-row">
        <button id="send-btn" style="width:40px; font-size:16px;" onclick="document.getElementById('file-input').click()">üñºÔ∏è</button>
        <input id="txt-input" placeholder="Message..." onkeydown="if(event.key==='Enter') send()">
        <button id="send-btn" onclick="send()">‚û§</button>
    </div>
    <input type="file" id="file-input" accept="image/*" onchange="handleImage(event)">
</div>

<script>
// --- CONFIGURATION ---
// YOUR NEW KEY IS INSTALLED HERE:
const apiKey = "AIzaSyCZ-z5WHGTlHVcIsTN6xGtszwV1SboiEfo";

// --- VARIABLES ---
// Starting with Flash 002 because it is the most stable globally
let currentModel = "gemini-1.5-flash-002";
let history = [];
let imgData = null;
let imgType = null;

// --- CORE ---
function manualSwitch() {
    let sel = document.getElementById('model-select');
    currentModel = sel.value;
    addMsg('sys-msg', `Switched to: ${sel.options[sel.selectedIndex].text}`);
}

async function send() {
    let input = document.getElementById('txt-input');
    let text = input.value.trim();
    if(!text && !imgData) return;

    // Update UI
    input.value = "";
    addMsg('user', text || "[Image]");
    updateOrb('thinking');

    // Build History
    let hist = history.slice(-10).map(h => ({ role: h.role, parts: [{ text: h.text }] }));
    
    // Build Current Message
    let userParts = [];
    if(text) userParts.push({ text: text });
    if(imgData) userParts.push({ inline_data: { mime_type: imgType, data: imgData } });
    
    let contents = [...hist, { role: "user", parts: userParts }];

    // ATTEMPT 1: Try the selected model
    let success = await tryModel(currentModel, contents, text);

    // ATTEMPT 2: If failed, try the older reliable backup (Flash 001)
    if(!success) {
        addMsg('sys-msg', "‚ö†Ô∏è Primary brain busy. Switching to Backup (Flash v1)...");
        document.getElementById('model-select').value = "gemini-1.5-flash-001";
        success = await tryModel("gemini-1.5-flash-001", contents, text);
    }

    // Cleanup
    if(imgData) clearImage();
    updateOrb('idle');
    
    if(!success) {
        addMsg('sys-msg', "‚ùå CONNECTION FAILED. Please ensure your Google Cloud Project has the 'Generative Language API' enabled.");
        updateOrb('error');
    }
}

async function tryModel(model, contents, originalText) {
    try {
        console.log("Connecting to:", model);
        let req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                contents: contents,
                system_instruction: { parts: [{ text: "You are Helix. Be concise, helpful, and friendly." }] }
            })
        });

        let res = await req.json();
        
        if(res.error) {
            console.warn(`${model} Error:`, res.error);
            return false; // Return false to trigger backup
        }

        let reply = res.candidates[0].content.parts[0].text;
        addMsg('ai', reply);
        history.push({ role: 'user', text: originalText || "[Image]" });
        history.push({ role: 'model', text: reply });
        speak(reply);
        return true;

    } catch(e) {
        console.error(e);
        return false;
    }
}

// --- UTILS ---
function addMsg(type, text) {
    let d = document.createElement('div');
    d.className = type;
    if(type === 'ai') {
        d.innerHTML = text.replace(/```(\w*)([\s\S]*?)```/g, '<div class="code-block">$2</div>').replace(/\n/g, '<br>');
    } else {
        d.innerText = text;
    }
    document.getElementById('console').appendChild(d);
    document.getElementById('console').scrollTop = 99999;
}

function updateOrb(state) {
    let orb = document.getElementById('core');
    let txt = document.getElementById('orb-text');
    orb.className = state === 'thinking' ? 'thinking' : (state === 'error' ? 'error' : '');
    txt.innerText = state === 'thinking' ? "THINKING" : "HELIX";
}

function speak(text) {
    if(!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
    u.rate = 1.1; 
    window.speechSynthesis.speak(u);
}

// --- IMAGE HANDLING ---
function handleImage(e) {
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = (e) => {
        imgData = e.target.result.split(',')[1];
        imgType = file.type;
        let p = document.getElementById('image-preview');
        p.style.display = 'block';
        p.style.backgroundImage = `url(${e.target.result})`;
    };
    reader.readAsDataURL(file);
}

function clearImage() {
    imgData = null;
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('file-input').value = "";
}

function clearMemory() {
    history = [];
    document.getElementById('console').innerHTML = "";
    addMsg('sys-msg', "Memory Wiped.");
}

// --- PWA REGISTRATION ---
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
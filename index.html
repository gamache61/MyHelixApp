<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  <title>Helix v48.9 - Styled Code blocks</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7159/7159502.png">
  <style>
    body { background: #000; color: #fff; font-family: -apple-system, sans-serif; height: 100dvh; margin: 0; display: flex; flex-direction: column; overflow: hidden; }
    #scene { height: 25%; min-height: 140px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border-bottom: 1px solid #333; position: relative; }
    #core { width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #fff, #0ff, #001); border-radius: 50%; box-shadow: 0 0 30px cyan; display: flex; justify-content: center; align-items: center; transition: 0.3s; z-index: 2; animation: float 6s ease-in-out infinite; }
    #core span { font-size: 10px; font-weight: 900; letter-spacing: 1px; color: rgba(0,0,0,0.6); font-family: monospace; pointer-events: none; }
    #core.listening { background: radial-gradient(circle at 30% 30%, #fff, #5f5, #010) !important; box-shadow: 0 0 60px lime !important; transform: scale(1.1); }
    #core.thinking { background: radial-gradient(circle at 30% 30%, #fff, #fb0, #420) !important; box-shadow: 0 0 50px orange !important; animation: pulseFast 0.5s alternate infinite !important; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes pulseFast { 0% { transform: scale(0.95); opacity: 0.8; } 100% { transform: scale(1.0); opacity: 1; } }
    
    #ui-layer { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #0a0a0a; gap: 10px; overflow: hidden; position: relative; }
    #header-row { display: flex; justify-content: space-between; align-items: center; min-height: 30px; }
    #model-badge { background: #112; color: #aaf; border: 1px solid #336; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; font-family: monospace; }
    #console { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #222; border-radius: 8px; background: #000; display: flex; flex-direction: column; gap: 12px; }
    
    .msg { padding: 12px; border-radius: 12px; font-size: 15px; max-width: 100%; line-height: 1.4; word-wrap: break-word; position: relative; }
    .user { align-self: flex-end; background: #222; color: #fff; max-width: 85%; }
    .ai { align-self: flex-start; background: transparent; color: #ccc; width: 100%; box-sizing: border-box; }

    /* Screenshot-style Code Block */
    .code-container { background: #1a1a1a; border-radius: 8px; overflow: hidden; margin-top: 10px; border: 1px solid #333; }
    .code-header { background: #252525; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    .code-title { color: #eee; font-size: 12px; font-family: monospace; font-weight: bold; }
    .copy-btn-icon { background: transparent; border: none; cursor: pointer; color: #aaa; display: flex; align-items: center; transition: 0.2s; }
    .copy-btn-icon:hover { color: #fff; }
    
    pre { margin: 0; padding: 15px; overflow-x: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; color: #d4d4d4; background: #121212; }
    .key { color: #ce9178; } /* Orange-ish for JSON keys */
    .string { color: #b5cea8; } /* Green-ish for values */
    .bracket { color: #ffd700; }

    #settings-panel { display: none; position: absolute; inset: 0; background: #000; z-index: 9999; flex-direction: column; align-items: center; padding: 30px; box-sizing: border-box; overflow-y: auto; }
    #settings-panel.active { display: flex !important; }
    .setting-label { color:#888; font-size:12px; margin-top:15px; width:100%; font-weight:bold; text-align: left; }
    .key-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; margin-bottom: 10px; font-family: monospace; }
    #input-row { display: flex; gap: 8px; align-items: center; margin-top: auto; padding: 10px; }
    #txt-input { flex-grow: 1; padding: 12px; border-radius: 12px; border: 1px solid #333; background: #111; color: white; font-size: 16px; outline: none; }
    .action-btn { background: #222; color: #aaa; border: 1px solid #333; border-radius: 12px; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
  </style>
</head>
<body>

<div id="settings-panel">
    <h2 style="color:cyan; font-family:monospace;">HELIX CONFIG</h2>
    <div class="setting-label">Active Model</div>
    <select id="model-select" class="key-input">
        <option value="llama-3.3-70b-versatile">Groq: Llama 3.3</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
    </select>
    <div class="setting-label">Groq API Key</div>
    <input type="text" id="groq-key-input" class="key-input" placeholder="gsk_...">
    <div class="setting-label">Google API Key</div>
    <input type="text" id="google-key-input" class="key-input" placeholder="AIza...">
    <button style="width:100%; padding:15px; background:cyan; border-radius:10px; font-weight:bold; color:black; margin-bottom:10px;" onclick="saveSettings()">SAVE & REFRESH</button>
    <button style="width:100%; padding:10px; background:transparent; border:1px solid #f44; border-radius:10px; font-weight:bold; color:#f44;" onclick="clearHistory()">CLEAR MEMORY</button>
</div>

<div id="scene"><div id="core"><span id="orb-text">HELIX</span></div></div>

<div id="ui-layer">
  <div id="header-row">
    <div id="model-badge">READY</div>
    <button class="action-btn" style="width:auto; padding:0 15px; font-size:12px;" onclick="toggleSettings()">âš™ SETTINGS</button>
  </div>
  <div id="console"></div>
  <div id="input-row">
      <input id="txt-input" placeholder="Message..." onkeydown="if(event.key==='Enter') sendText()">
      <button id="mic-btn" class="action-btn" onclick="handleMicClick()">ðŸŽ¤</button>
      <button class="action-btn" onclick="sendText()" style="color:cyan;">â–¶</button>
  </div>
</div>

<script>
let googleKey = localStorage.getItem('helix_google_key_v47') || "";
let groqKey = localStorage.getItem('helix_groq_key_v47') || "";
let currentModel = localStorage.getItem('helix_model_v47') || "llama-3.3-70b-versatile";
let chatHistory = JSON.parse(localStorage.getItem('helix_history_v47')) || [];

let micEnabled = false;
let recognition = null;
const systemRules = "You are HELIX. Rule: If providing a fix or code, wrap it in a code block with the language name (e.g. ```json).";

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.onstart = () => { updateOrb('listening', 'LISTENING'); };
    recognition.onend = () => { updateOrb('', 'HELIX'); };
    recognition.onresult = (e) => { document.getElementById('txt-input').value = e.results[0][0].transcript; sendText(); };
}

window.onload = () => {
    updateBadge();
    chatHistory.forEach(msg => addMessage(msg.role === 'assistant' ? 'ai' : 'user', msg.content));
    if (!googleKey && !groqKey) toggleSettings();
};

function toggleSettings() { document.getElementById('settings-panel').classList.toggle('active'); }
function saveSettings() {
    localStorage.setItem('helix_google_key_v47', document.getElementById('google-key-input').value.trim());
    localStorage.setItem('helix_groq_key_v47', document.getElementById('groq-key-input').value.trim());
    localStorage.setItem('helix_model_v47', document.getElementById('model-select').value);
    location.reload();
}
function clearHistory() { if(confirm("Clear memory?")) { chatHistory = []; localStorage.removeItem('helix_history_v47'); document.getElementById('console').innerHTML = ""; } }

async function sendText() {
    const input = document.getElementById('txt-input'); 
    const t = input.value.trim();
    if (!t) return;

    const isGroq = currentModel.includes('llama');
    const activeKey = isGroq ? groqKey : googleKey;
    if (!activeKey) return toggleSettings();

    input.value = ""; 
    addMessage('user', t);
    chatHistory.push({ role: 'user', content: t });
    updateOrb('thinking', 'PROCESSSING...');

    try {
        let response;
        if (isGroq) {
            response = await fetch('[https://api.groq.com/openai/v1/chat/completions](https://api.groq.com/openai/v1/chat/completions)', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${activeKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: currentModel, messages: [{ role: 'system', content: systemRules }, ...chatHistory] })
            });
        } else {
            const geminiContents = chatHistory.map(m => ({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.content }] }));
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${activeKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ system_instruction: { parts: [{ text: systemRules }] }, contents: geminiContents })
            });
        }
        const data = await response.json();
        let aiText = isGroq ? data.choices[0].message.content : data.candidates[0].content.parts[0].text;
        
        chatHistory.push({ role: 'assistant', content: aiText });
        if (chatHistory.length > 20) chatHistory.shift();
        localStorage.setItem('helix_history_v47', JSON.stringify(chatHistory));

        addMessage('ai', aiText);
        updateOrb('', 'HELIX');
    } catch (e) { addMessage('system', "Error: " + e.message); }
}

function updateOrb(cls, txt) { document.getElementById('core').className = cls; document.getElementById('orb-text').innerText = txt; }
function updateBadge() { document.getElementById('model-badge').innerText = currentModel.toUpperCase(); }

function handleMicClick() {
    if (!recognition) return alert("Mic not supported.");
    recognition.start();
}

function copyCode(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        btn.innerHTML = 'âœ…';
        setTimeout(() => { btn.innerHTML = 'ðŸ“‹'; }, 2000);
    });
}

function addMessage(role, text) {
  const consoleDiv = document.getElementById('console'); 
  const msg = document.createElement('div');
  msg.className = 'msg ' + (role === 'assistant' ? 'ai' : role);

  // Check if response has a code block
  if (text.includes("```")) {
    const parts = text.split("```");
    let contentHtml = parts[0].replace(/\n/g, '<br>'); // Text before code
    
    for (let i = 1; i < parts.length; i += 2) {
      const codeBlock = parts[i];
      const lines = codeBlock.split('\n');
      const lang = lines[0].trim().toUpperCase() || "CODE";
      const code = lines.slice(1).join('\n').trim();

      contentHtml += `
        <div class="code-container">
          <div class="code-header">
            <span class="code-title">${lang}</span>
            <button class="copy-btn-icon" onclick="copyCode(\`${code.replace(/`/g, '\\`')}\`, this)">ðŸ“‹</button>
          </div>
          <pre>${code.replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m]))}</pre>
        </div>
      `;
      if (parts[i+1]) contentHtml += parts[i+1].replace(/\n/g, '<br>'); // Text after code
    }
    msg.innerHTML = contentHtml;
  } else {
    msg.innerHTML = text.replace(/\n/g, '<br>');
  }
  
  consoleDiv.appendChild(msg); 
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}
</script>
</body>
</html>